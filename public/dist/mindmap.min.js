!function(a){var b,c={init:function(d){var e=a(this);b=a.extend({nodeClass:"node",nodeInputClass:"node__input",nodeTextClass:"node__text",activeClass:"node_active",editableClass:"node_editable",rootClass:"node_root",childrenClass:"children",childrenItemClass:"children__item",leftBranch:"children_leftbranch",rightBranch:"children_rightbranch",root:e,balance:!0},d),b.nodes=e.find("."+b.nodeClass),b.nodeInput=e.find("."+b.nodeInputClass),b.activeNode=e.find(b.activeClass).length?e.find(b.activeClass):null,a(document).on("keydown",function(d){if(b.activeNode){var e,f,g=d.which||d.keyCode,h=b.activeNode;switch(g){case 13:if(h.hasClass(b.editableClass))return c.blur(),c.setActive(h),!1;if(h.hasClass(b.rootClass))return;c.addNode();break;case 9:h.hasClass(b.editableClass)?(c.blur(),c.setActive(h)):(d.preventDefault(),c.addChildNode());break;case 27:break;case 8:case 46:if(h.hasClass(b.editableClass))return!0;if(h.hasClass(b.rootClass))return!1;f=h.parent().next().children("."+b.nodeClass),parentNode=h.parent().parent().prev(),d.preventDefault(),c.removeNode(),f.length?(f.addClass(b.activeClass),b.activeNode=f):(parentNode.addClass(b.activeClass),b.activeNode=parentNode);break;case 37:if(h.hasClass(b.editableClass))return!0;h.hasClass(b.rootClass)?c.selectChildNode(a("."+b.leftBranch)):h.closest("."+b.rightBranch).length?c.selectParentNode():c.selectChildNode();break;case 38:if(h.hasClass(b.editableClass))return!0;e=h.parent().prev().children("."+b.nodeClass),e.length&&(c.blur(),c.setActive(e));break;case 39:if(h.hasClass(b.editableClass))return!0;h.hasClass(b.rootClass)?c.selectChildNode(a("."+b.rightBranch)):h.closest("."+b.rightBranch).length?c.selectChildNode():c.selectParentNode();break;case 40:if(h.hasClass(b.editableClass))return!0;f=h.parent().next().children("."+b.nodeClass),f.length&&(c.blur(),c.setActive(f))}}}),e.on("click","."+b.nodeClass,function(){var d=a(this);d.hasClass(b.activeClass)?(c.blur(),c.setActive(d),c.setEditable(d)):(c.blur(),c.setActive(d))}).on("input paste","."+b.nodeInputClass,function(){var c=b.activeNode,d=c.find("."+b.nodeTextClass),e=a(this);d.text(e.val())}).on("keydown","."+b.nodeInputClass,function(a){var b=a.which||a.keyCode;9===b&&a.preventDefault()})},destroy:function(){a(window).unbind(".mindmap")},selectParentNode:function(){var a,d=b.activeNode,e=d.parent().parent().parent();a=e.children("."+b.nodeClass),c.blur(),c.setActive(a)},selectChildNode:function(a){var d,e=b.activeNode;a||(a=e.parent().children("."+b.childrenClass)),d=a.children("."+b.childrenItemClass+":first-child").children("."+b.nodeClass),d.length&&(c.blur(),c.setActive(d))},removeNode:function(){var a=b.activeNode,d=a.parent(),e=d.parent(),f=e.children().length-1;f?d.remove():e.remove(),c.blur(),c.balance()},addNode:function(){var a,d,e=b.activeNode.parent().parent();e.append(c.getTemplate(1)),a=e.children("."+b.childrenItemClass+":last"),d=a.children("."+b.nodeClass),c.blur(),c.setEditable(d),c.balance()},addChildNode:function(){var a,d,e=b.activeNode.parent(),f=e.children("."+b.childrenClass);f.length?(b.activeNode.hasClass(b.rootClass)&&2===f.length&&(f=f.filter("."+b.leftBranch)),f.append(c.getTemplate(1)),a=f.children("."+b.childrenItemClass+":last"),d=a.children("."+b.nodeClass)):(e.append(c.getTemplate(1,1)),f=e.children("."+b.childrenClass),a=f.children("."+b.childrenItemClass+":last"),d=a.children("."+b.nodeClass)),c.blur(),c.setEditable(d),c.balance()},blur:function(){if(b.activeNode){var a=b.activeNode,c=a.find("."+b.nodeTextClass),d=a.find("."+b.nodeInputClass);a.hasClass(b.editableClass)&&(c.text(d.val()),d.blur()),a.removeClass(b.activeClass).removeClass(b.editableClass),b.activeNode=null}},setActive:function(a){a.addClass(b.activeClass),b.activeNode=a},setEditable:function(a){var c=a.find("."+b.nodeInputClass),d=a.find("."+b.nodeTextClass);a.addClass(b.activeClass).addClass(b.editableClass).attr("data-value",d.text()),c.val(d.text()).focus().select(),b.activeNode=a},balance:function(){if(b.balance){var d,e,f,g,h,i=0,j=a("."+b.rightBranch),k=a("."+b.leftBranch),l=0,m=b.root.children("."+b.childrenClass);if(!j.length)if(h=m.not("."+b.leftBranch),h.length)h.addClass(b.rightBranch);else{if(!m.length)return;m.eq(0).removeClass(b.leftBranch).addClass(b.rightBranch).appendTo(b.root)}if(!k.length)if(h=m.not("."+b.rightBranch),h.length)h.addClass(b.leftBranch);else{if(!m.length)return;b.root.prepend(c.getTemplate(0,1)),b.root.children("."+b.childrenClass).not("."+b.rightBranch).addClass(b.leftBranch)}g=k.children(),f=j.children(),l=j.outerHeight()+k.outerHeight(),d=.5*l;for(var n=0,o=f.length;o>n;n++){if(i+=f.eq(n).outerHeight(),e=Math.abs(.5*l-i),!(d>=e))return c.moveNodes(1,n,o),void 0;d=e}for(var p=0,q=g.length;q>p;p++){if(i+=g.eq(p).outerHeight(),e=Math.abs(.5*l-i),!(d>=e))return p>0&&c.moveNodes(0,0,p-1),void 0;d=e}c.clearEmptyBranches()}},moveNodes:function(d,e,f){var g,h,i;h=d?a("."+b.rightBranch):a("."+b.leftBranch),i=d?a("."+b.leftBranch):a("."+b.rightBranch),g=h.children(),g.each(function(b){b>=e&&f>=b&&a(this).appendTo(i)}),c.clearEmptyBranches()},clearEmptyBranches:function(){var c=b.root.children("."+b.childrenClass);c.each(function(){a(this).children().length||a(this).remove()})},getTemplate:function(a,c){var d="";return d+=c?' <ol class="'+b.childrenClass+'">':"",d+=a?'<li class="'+b.childrenItemClass+'"><div class="'+b.nodeClass+'"><div class="'+b.nodeTextClass+'">Node</div><input class="'+b.nodeInputClass+'" type="text"></div></li> ':"",d+=c?"</ol>":""}};a.fn.mindmap=function(b){return c[b]?c[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?(a.error("Unknown method: "+b),void 0):c.init.apply(this,arguments)}}(jQuery);